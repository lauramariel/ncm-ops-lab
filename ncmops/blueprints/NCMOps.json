{"status":{},"contains_secrets":false,"product_version":"3.4.1","spec":{"description":"This blueprint deploys the NCM Ops Webserver that acts as a proxy to PC and provides a UI for generating alerts and creating tickets. It is meant to replace the steps required in Step 2 Configuring the VM here: https:\/\/docs.google.com\/document\/d\/1I94_GUZcDS2fBa5h3IggbewjyR841X3khLDrZ26eJQg\/edit?usp=sharing \n\n* [PC Proxy](http:\/\/@@{NCMOpsSvc.URL}@@)\n* [Generate Alerts](http:\/\/@@{NCMOpsSvc.URL}@@\/alerts)\n* [Ticket System](http:\/\/@@{NCMOpsSvc.URL}@@\/ticketsystem)","resources":{"client_attrs":{"c9c2e22a_deployment":{"y":451,"x":648.5}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"NCMOpsSvc"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"cef9fdc6_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"d7db219c_runbook","main_task_local_reference":{"kind":"app_task","name":"cef9fdc6_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"NCMOpsSvc"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"536194d0_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"bff46f9a_runbook","main_task_local_reference":{"kind":"app_task","name":"536194d0_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"NCMOpsSvc"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"349f7463_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"9f509ed1_runbook","main_task_local_reference":{"kind":"app_task","name":"349f7463_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"NCMOpsSvc"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"e9f1ddd8_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"63d9f30e_runbook","main_task_local_reference":{"kind":"app_task","name":"e9f1ddd8_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"NCMOpsSvc"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"be5e4ddb_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"92b30dbd_runbook","main_task_local_reference":{"kind":"app_task","name":"be5e4ddb_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"NCMOpsSvc","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"PC_IP","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"URL","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"AHV_VM","name":"VM1","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"0","disable_readiness_probe":true},"editables":{"create_spec":{"name":true}},"os_type":"Linux","create_spec":{"name":"ncmops-@@{calm_application_name}@@-@@{calm_time}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"93d4b272-3edf-490d-93be-67afb7fb71b4"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":2,"gpu_list":[],"memory_size_mib":2048,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":null,"power_state":"ON","type":"","account_uuid":"d6cab01f-6a69-4cda-9207-f2be331c9541","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"LEGACY","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"app_package","type":"","name":"NCMOpsWebserver","uuid":"9d89ba1f-be4e-861c-e5e3-3dd4a9142236"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"admin","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"PC_CREDS","cred_class":"static"},{"username":"root","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"WebserverCreds","cred_class":"static"},{"username":"nutanix","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"PC_SSH_CREDS","cred_class":"static"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"NCMOpsSvc"}],"name":"Package1","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Get PC IP"},{"kind":"app_task","name":"Configure Webserver"},{"kind":"app_task","name":"Set URL"}],"name":"1d0c6893_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Get PC IP"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Configure Webserver"}},{"from_task_reference":{"kind":"app_task","name":"Configure Webserver"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Set URL"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"NCMOpsSvc"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Get PC IP","attrs":{"exit_status":[],"script":"jwt = '@@{calm_jwt}@@'\n\n# Get PC IP and PE uuid\napi_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/prism_central'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json', 'Authorization': 'Bearer {}'.format(jwt)}\n\nr = urlreq(api_url, verb='GET', headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n\n    pc_ip = resp['resources']['pc_vm_list'][0]['nic_list'][0]['ip_list'][0]\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\nprint(\"PC_IP={}\".format(pc_ip))","eval_variables":["PC_IP"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"NCMOpsSvc"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Configure Webserver","attrs":{"exit_status":[],"script":"echo \"configuring local-config-ssp.js\"\necho \"Setting proxyHost to IP @@{PC_IP}@@\"\nsed -i \"s\/proxyHost: ''\/proxyHost: '@@{PC_IP}@@'\/g\" \/root\/webserver\/local-config-ssp.js\necho \"Setting userPass to @@{PC_CREDS.secret}@@\"\nsed -i \"s\/userPass: 'Nutanix\\\/4u'\/userPass: '@@{PC_CREDS.secret}@@'\/g\" \/root\/webserver\/local-config-ssp.js\necho \"Setting sshPass to @@{PC_SSH_CREDS.secret}@@\"\nsed -i \"s\/sshPass: 'nutanix\\\/4u'\/sshPass: '@@{PC_SSH_CREDS.secret}@@'\/g\" \/root\/webserver\/local-config-ssp.js\necho \"Restarting webserver\"\npm2 restart prismpro-webserver","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"WebserverCreds"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"NCMOpsSvc"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Set URL","attrs":{"exit_status":[],"script":"print(\"URL={}\".format(\"@@{address}@@\"))","eval_variables":["URL"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"036bb95a_runbook","main_task_local_reference":{"kind":"app_task","name":"1d0c6893_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"e82cd195_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"a8d052fe_runbook","main_task_local_reference":{"kind":"app_task","name":"e82cd195_dag"},"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"SUBSTRATE_IMAGE","service_local_reference_list":[],"name":"NCMOpsWebserver","version":"","options":{"type":"","name":"NCMOpsWebserver","resources":{"image_type":"DISK_IMAGE","checksum":{},"source_uri":"http:\/\/10.42.194.11\/workshop_staging\/NCMOpsLabUtilityServer.qcow2 ","version":{},"architecture":"X86_64","type":""},"description":""},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"c9c2e22a_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package1"}],"substrate_local_reference":{"kind":"app_substrate","name":"VM1"},"variable_list":[],"description":""}],"environment_reference_list":["e52688ed-aad5-1c33-9237-9f4e8569cb4e"],"patch_list":[{"name":"Config1","type":"PATCH","is_system_generated":false,"variable_list":[],"attrs_list":[{"target_any_local_reference":{"kind":"app_blueprint_deployment","name":"c9c2e22a_deployment"},"data":{"num_vcpus_per_socket_ruleset":{"type":""},"num_sockets_ruleset":{"type":""},"disk_delete_allowed":false,"pre_defined_nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"editable":false,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"93d4b272-3edf-490d-93be-67afb7fb71b4"},"operation":"modify","identifier":"0","type":""}],"categories_delete_allowed":false,"pre_defined_categories":[],"pre_defined_disk_list":[{"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"},"operation":"modify","data_source_reference":{"kind":"image","type":"","name":"NCMOpsLabUtilityServer.qcow2","uuid":"280373c8-cc9a-4418-a3d4-87cf0748e56e"},"type":"","disk_size_mib":null,"volume_group_reference":null}],"nic_delete_allowed":false,"type":"nutanix","memory_size_mib_ruleset":{"type":""},"categories_add_allowed":false},"deployment_strategy":{},"uuid":"6e603d29-0d9b-a685-b5b3-81b82967fb1e"}],"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_profile","name":"Default"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Config1_meta_task"}],"name":"SYS_GEN__DAG_Patch_Config1_8d50bf54_a6b6_bd7b_d8f4_08a6e9611a66","attrs":{"edges":[],"type":"DAG"},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_profile","name":"Default"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Config1_update_spec_task"},{"kind":"app_task","name":"Config1_Service1"}],"name":"Config1_meta_task","attrs":{"type":"","patch_attrs_reference":["6e603d29-0d9b-a685-b5b3-81b82967fb1e"]},"timeout_secs":"0","type":"PATCH_META","variable_list":[]},{"target_any_local_reference":{"kind":"app_profile","name":"Default"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Config1_update_spec_task","attrs":{"type":""},"timeout_secs":"0","type":"UPDATE_SPEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_blueprint_deployment","name":"c9c2e22a_deployment"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"SYS_GEN__stop"},{"kind":"app_task","name":"SYS_GEN__Nutanix_Update_a1057dd7_f1f9_ef94_86ab_94ac7c56b9af"},{"kind":"app_task","name":"SYS_GEN__start"}],"name":"Config1_Service1","attrs":{"loop_variable":"","type":"","loop_counter":"","exit_condition_type":"","patch_attr_reference":"6e603d29-0d9b-a685-b5b3-81b82967fb1e","loop_over_list":""},"timeout_secs":"0","type":"FOR_LOOP","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"NCMOpsSvc"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"SYS_GEN__stop","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"63d9f30e_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"VM1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"SYS_GEN__Nutanix_Update_a1057dd7_f1f9_ef94_86ab_94ac7c56b9af","attrs":{"type":""},"timeout_secs":"0","type":"UPDATE_NUTANIX","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"NCMOpsSvc"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"SYS_GEN__start","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"9f509ed1_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"SYS_GEN__Runbook_Patch_Config1_8d50bf54_a6b6_bd7b_d8f4_08a6e9611a66","main_task_local_reference":{"kind":"app_task","name":"SYS_GEN__DAG_Patch_Config1_8d50bf54_a6b6_bd7b_d8f4_08a6e9611a66"},"variable_list":[]},"config_reference_list":[],"description":""}],"description":"","action_list":[],"name":"Default","restore_config_list":[],"snapshot_config_list":[],"variable_list":[]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"PC_CREDS"},"type":"USER"},"name":"NCMOps"},"api_version":"3.0","metadata":{"last_update_time":"1656723778568528","kind":"blueprint","spec_version":31,"creation_time":"1656717392116493","name":"NCMOps"}}